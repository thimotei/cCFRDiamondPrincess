library(bbmle)
library(plotrix)
library(fitdistrplus)
library(padr)
source("R/cCFR_calculation.R")
#library(magrittr)
#library(tidyverse)
cruiseShipData <- read.csv("data/new_data.csv")
cruiseShipData <- cruiseShipData %>% arrange(date)
cruiseShipData$date <- as.Date(cruiseShipData$date)
#importing case and death data
cruise_ship_by_confirmation <- read.csv("data/cruise_ship_diamond_princess_by_confirmation.csv")
# importing the age-stratified scale factors
cruise_ship_SFs <- read.csv("data/age_scale_factors.csv")
sfIFR <- cruise_ship_SFs$ifrSF
cruise_ship_by_confirmation$date <- as.Date(cruise_ship_by_confirmation$date)
# age distribution of cruise ship individuals
cruise_ship_ages <- c(16,23,347, 428,334,398,923,1015,216,11)
# Reproducing the distribution from onset-to-death
# Linton et al. (https://doi.org/10.3390/jcm9020538)
zmeanOD <- 14.5
zsdOD <- 6.7
zmedianOD <- 13.2
muOD <- log(zmedianOD)
sigmaOD <- sqrt(2*(log(zmeanOD) - muOD))
onset_to_death <- function(x)
{
dlnorm(x, muOD, sigmaOD)
}
zmeanODT <- 20.2
zsdODT <- 11.6
zmedianODT <- 17.1
muODT <- log(zmedianODT)
sigmaODT <- sqrt( 2*(log(zmeanODT) - muODT))
onset_to_death_truncated <- function(x)
{
dlnorm(x, muODT, sigmaODT)
}
zmeanHD <- 8.6
zmeanLow <- 6.8
zmeanHigh <- 10.8
zsdHD <- 6.7
zmedianHD <- 6.7
zmedianHDLow <- 5.3
zmedianHDHigh <- 8.3
muHD <- log(zmedianHD)
sigmaHD <- sqrt(2*(log(zmeanHD) - muHD))
hospitalisation_to_death <- function(x)
{
dlnorm(x, muHD, sigmaHD)
}
zmeanHDT <- 13
zmeanHDTLow <- 8.7
zmeanHDTHigh <- 20.9
zsdHDT <- 12.7
zmedianHDT <- 9.1
zmedianHDTLow <- 6.7
zmedianHDTHigh <- 13.7
muHDT <- log(zmedianHDT)
sigmaHDT <- sqrt(2*(log(zmeanHDT) - muHDT))
hospitalisation_to_death_truncated <- function(x)
{
dlnorm(x, muHDT, sigmaHDT)
}
f_truncrated <- numeric()
for(i in 0:50)
{
f_truncrated[i+1] <- integrate(hospitalisation_to_death_truncated, i-1, i)
}
f_truncrated_low <- numeric()
for(i in 0:50)
{
f_truncrated_low[i+1] <- integrate(hospitalisation_to_death_truncated_low, i-1, i)
}
f_truncrated_mid_one <- numeric()
for(i in 0:50)
{
f_truncrated_mid_one[i+1] <- integrate(hospitalisation_to_death_truncated_mid_one, i-1, i)
}
f_truncrated_high <- numeric()
for(i in 0:50)
{
f_truncrated_high[i+1] <- integrate(hospitalisation_to_death_truncated_high, i-1, i)
}
nLarge <- 10
for(i in 1:nLarge)
{
zmeanHDTBS <- runif(1, zmeanHDTLow, zmeanHDTHigh)
zmedianHDTBS <- runif(1, zmedianHDTLow, zmedianHDTHigh)
hospitalisation_to_death_truncatedBS <- function(x)
{
dlnorm(x, muHDT, sigmaHDT)
}
fBS <- numeric()
for(i in 0:50)
{
fBS[i + 1] <- integrate(hospitalisation_to_death_truncated, i - 1, i)
}
}
muHDTLow <- log(zmedianHDTLow)
sigmaHDTLow <- sqrt(2*(log(zmeanHDTLow) - muHDTLow))
hospitalisation_to_death_truncated_low <- function(x)
{
dlnorm(x, muHDTLow, sigmaHDTLow)
}
muHDTMidOne <- log(zmedianHDTLow)
sigmaHDTMidOne <- sqrt(2*(log(zmeanHDTHigh) - muHDTMidOne))
hospitalisation_to_death_truncated_mid_one <- function(x)
{
dlnorm(x, muHDTMidOne, sigmaHDTMidOne)
}
#muHDTMidTwo <- log(zmedianHDTHigh)
#sigmaHDTMidTwo <- sqrt(2*(log(zmeanHDTLow) - muHDTMidTwo))
#hospitalisation_to_death_truncated_mid_two <- function(x)
#{
#  dlnorm(x, muHDTMidTwo, sigmaHDTMidTwo)
#}
muHDTHigh <- log(zmedianHDTHigh)
sigmaHDTHigh <- sqrt(2*(log(zmeanHDTHigh) - muHDTHigh))
hospitalisation_to_death_truncated_high <- function(x)
{
dlnorm(x,muHDTHigh, sigmaHDTHigh)
}
source("R/plotting_functions.R")
source("R/cCFR_calculation.R")
# running the script for plotting Figure 1 in the main text
master_plot(cruiseShipData, 1, 1, "topright", hospitalisation_to_death_truncated)
figure_supplementary <- plotDelaysSupplementary()
# running the code to produce the IFR and CFR estimates quoted in the manuscript
cIFREstimate <- computecCFRTimeSeries(cruise_ship_by_confirmation, hospitalisation_to_death_truncated_mid_one, f_truncrated_mid_one)
cCFREstimate <- data.frame(date = cCFREstimate$date, ci_mid = cCFREstimate$ci_mid*sfIFR[1], ci_low = cCFREstimate$ci_low*sfIFR[1], ci_high = cCFREstimate$ci_high*sfIFR[1])
cases_scaled_by_age <- scale_by_age_distribution_cases(cruise_ship_by_confirmation, cruise_ship_SFs)
deaths_scaled_by_age <- scale_by_age_distribution_deaths(cruise_ship_by_confirmation, cruise_ship_SFs)
ageGroupStratified <- data.frame(date = cruise_ship_by_confirmation$date, new_cases = round(cases_scaled_by_age[,9]), new_deaths = round(deaths_scaled_by_age[,9]))
cCFRAgeGroupStratified <- computecCFRTimeSeries(ageGroupStratified, hospitalisation_to_death, f_truncrated)
cCFRTAgeGroupStratified <- computecCFRTimeSeries(ageGroupStratified, hospitalisation_to_death_truncated, f_truncrated)
cIFRAgeGroupStratified <- data.frame(date = cCFRAgeGroupStratified$date, ci_mid = cCFRAgeGroupStratified$ci_mid*sfIFR[1], ci_low = cCFRAgeGroupStratified$ci_low*sfIFR[1], ci_high = cCFRAgeGroupStratified$ci_high*sfIFR[1])
cIFRTAgeGroupStratified <- data.frame(date = cCFRTAgeGroupStratified$date, ci_mid = cCFRTAgeGroupStratified$ci_mid*sfIFR[1], ci_low = cCFRTAgeGroupStratified$ci_low*sfIFR[1], ci_high = cCFRTAgeGroupStratified$ci_high*sfIFR[1])
setwd("~/Documents/lshtm/github repos/cCFRDiamondPrincess")
library(bbmle)
library(plotrix)
library(fitdistrplus)
library(padr)
source("R/cCFR_calculation.R")
#library(magrittr)
#library(tidyverse)
cruiseShipData <- read.csv("data/new_data.csv")
cruiseShipData <- cruiseShipData %>% arrange(date)
cruiseShipData$date <- as.Date(cruiseShipData$date)
#importing case and death data
cruise_ship_by_confirmation <- read.csv("data/cruise_ship_diamond_princess_by_confirmation.csv")
# importing the age-stratified scale factors
cruise_ship_SFs <- read.csv("data/age_scale_factors.csv")
sfIFR <- cruise_ship_SFs$ifrSF
cruise_ship_by_confirmation$date <- as.Date(cruise_ship_by_confirmation$date)
# age distribution of cruise ship individuals
cruise_ship_ages <- c(16,23,347, 428,334,398,923,1015,216,11)
# Reproducing the distribution from onset-to-death
# Linton et al. (https://doi.org/10.3390/jcm9020538)
zmeanOD <- 14.5
zsdOD <- 6.7
zmedianOD <- 13.2
muOD <- log(zmedianOD)
sigmaOD <- sqrt(2*(log(zmeanOD) - muOD))
onset_to_death <- function(x)
{
dlnorm(x, muOD, sigmaOD)
}
zmeanODT <- 20.2
zsdODT <- 11.6
zmedianODT <- 17.1
muODT <- log(zmedianODT)
sigmaODT <- sqrt( 2*(log(zmeanODT) - muODT))
onset_to_death_truncated <- function(x)
{
dlnorm(x, muODT, sigmaODT)
}
zmeanHD <- 8.6
zmeanLow <- 6.8
zmeanHigh <- 10.8
zsdHD <- 6.7
zmedianHD <- 6.7
zmedianHDLow <- 5.3
zmedianHDHigh <- 8.3
muHD <- log(zmedianHD)
sigmaHD <- sqrt(2*(log(zmeanHD) - muHD))
hospitalisation_to_death <- function(x)
{
dlnorm(x, muHD, sigmaHD)
}
zmeanHDT <- 13
zmeanHDTLow <- 8.7
zmeanHDTHigh <- 20.9
zsdHDT <- 12.7
zmedianHDT <- 9.1
zmedianHDTLow <- 6.7
zmedianHDTHigh <- 13.7
muHDT <- log(zmedianHDT)
sigmaHDT <- sqrt(2*(log(zmeanHDT) - muHDT))
hospitalisation_to_death_truncated <- function(x)
{
dlnorm(x, muHDT, sigmaHDT)
}
f_truncrated <- numeric()
for(i in 0:50)
{
f_truncrated[i+1] <- integrate(hospitalisation_to_death_truncated, i-1, i)
}
f_truncrated_low <- numeric()
for(i in 0:50)
{
f_truncrated_low[i+1] <- integrate(hospitalisation_to_death_truncated_low, i-1, i)
}
f_truncrated_mid_one <- numeric()
for(i in 0:50)
{
f_truncrated_mid_one[i+1] <- integrate(hospitalisation_to_death_truncated_mid_one, i-1, i)
}
f_truncrated_high <- numeric()
for(i in 0:50)
{
f_truncrated_high[i+1] <- integrate(hospitalisation_to_death_truncated_high, i-1, i)
}
nLarge <- 10
for(i in 1:nLarge)
{
zmeanHDTBS <- runif(1, zmeanHDTLow, zmeanHDTHigh)
zmedianHDTBS <- runif(1, zmedianHDTLow, zmedianHDTHigh)
hospitalisation_to_death_truncatedBS <- function(x)
{
dlnorm(x, muHDT, sigmaHDT)
}
fBS <- numeric()
for(i in 0:50)
{
fBS[i + 1] <- integrate(hospitalisation_to_death_truncated, i - 1, i)
}
}
muHDTLow <- log(zmedianHDTLow)
sigmaHDTLow <- sqrt(2*(log(zmeanHDTLow) - muHDTLow))
hospitalisation_to_death_truncated_low <- function(x)
{
dlnorm(x, muHDTLow, sigmaHDTLow)
}
muHDTMidOne <- log(zmedianHDTLow)
sigmaHDTMidOne <- sqrt(2*(log(zmeanHDTHigh) - muHDTMidOne))
hospitalisation_to_death_truncated_mid_one <- function(x)
{
dlnorm(x, muHDTMidOne, sigmaHDTMidOne)
}
#muHDTMidTwo <- log(zmedianHDTHigh)
#sigmaHDTMidTwo <- sqrt(2*(log(zmeanHDTLow) - muHDTMidTwo))
#hospitalisation_to_death_truncated_mid_two <- function(x)
#{
#  dlnorm(x, muHDTMidTwo, sigmaHDTMidTwo)
#}
muHDTHigh <- log(zmedianHDTHigh)
sigmaHDTHigh <- sqrt(2*(log(zmeanHDTHigh) - muHDTHigh))
hospitalisation_to_death_truncated_high <- function(x)
{
dlnorm(x,muHDTHigh, sigmaHDTHigh)
}
source("R/plotting_functions.R")
source("R/cCFR_calculation.R")
# running the script for plotting Figure 1 in the main text
master_plot(cruiseShipData, 1, 1, "topright", hospitalisation_to_death_truncated)
figure_supplementary <- plotDelaysSupplementary()
# running the code to produce the IFR and CFR estimates quoted in the manuscript
cIFREstimate <- computecCFRTimeSeries(cruise_ship_by_confirmation, hospitalisation_to_death_truncated_mid_one, f_truncrated_mid_one)
cCFREstimate <- data.frame(date = cCFREstimate$date, ci_mid = cCFREstimate$ci_mid*sfIFR[1], ci_low = cCFREstimate$ci_low*sfIFR[1], ci_high = cCFREstimate$ci_high*sfIFR[1])
cases_scaled_by_age <- scale_by_age_distribution_cases(cruise_ship_by_confirmation, cruise_ship_SFs)
deaths_scaled_by_age <- scale_by_age_distribution_deaths(cruise_ship_by_confirmation, cruise_ship_SFs)
ageGroupStratified <- data.frame(date = cruise_ship_by_confirmation$date, new_cases = round(cases_scaled_by_age[,9]), new_deaths = round(deaths_scaled_by_age[,9]))
cCFRAgeGroupStratified <- computecCFRTimeSeries(ageGroupStratified, hospitalisation_to_death, f_truncrated)
cCFRTAgeGroupStratified <- computecCFRTimeSeries(ageGroupStratified, hospitalisation_to_death_truncated, f_truncrated)
cIFRAgeGroupStratified <- data.frame(date = cCFRAgeGroupStratified$date, ci_mid = cCFRAgeGroupStratified$ci_mid*sfIFR[1], ci_low = cCFRAgeGroupStratified$ci_low*sfIFR[1], ci_high = cCFRAgeGroupStratified$ci_high*sfIFR[1])
cIFRTAgeGroupStratified <- data.frame(date = cCFRTAgeGroupStratified$date, ci_mid = cCFRTAgeGroupStratified$ci_mid*sfIFR[1], ci_low = cCFRTAgeGroupStratified$ci_low*sfIFR[1], ci_high = cCFRTAgeGroupStratified$ci_high*sfIFR[1])
cIFREstimate
cruise_ship_by_confirmation$new_cases %>% sum
#importing case and death data
cruise_ship_by_confirmation <- read.csv("data/cruise_ship_diamond_princess_by_confirmation.csv")
# importing the age-stratified scale factors
cruise_ship_SFs <- read.csv("data/age_scale_factors.csv")
sfIFR <- cruise_ship_SFs$ifrSF
cruise_ship_by_confirmation$date <- as.Date(cruise_ship_by_confirmation$date)
# age distribution of cruise ship individuals
cruise_ship_ages <- c(16,23,347, 428,334,398,923,1015,216,11)
zmeanOD <- 14.5
# running the code to produce the IFR and CFR estimates quoted in the manuscript
cIFREstimate <- computecCFRTimeSeries(cruise_ship_by_confirmation, hospitalisation_to_death_truncated_mid_one, f_truncrated_mid_one)
cIFREstimate
cIFREstimate$ci_mid %>% mean
#importing case and death data
cruise_ship_by_confirmation <- read.csv("data/cruise_ship_diamond_princess_by_confirmation.csv")
# importing the age-stratified scale factors
cruise_ship_SFs <- read.csv("data/age_scale_factors.csv")
sfIFR <- cruise_ship_SFs$ifrSF
cruise_ship_by_confirmation$date <- as.Date(cruise_ship_by_confirmation$date)
# age distribution of cruise ship individuals
cruise_ship_ages <- c(16,23,347, 428,334,398,923,1015,216,11)
# running the code to produce the IFR and CFR estimates quoted in the manuscript
cIFREstimate <- computecCFRTimeSeries(cruise_ship_by_confirmation, hospitalisation_to_death_truncated_mid_one, f_truncrated_mid_one)
cIFREstimate
#importing case and death data
cruise_ship_by_confirmation <- read.csv("data/cruise_ship_diamond_princess_by_confirmation.csv")
# importing the age-stratified scale factors
cruise_ship_SFs <- read.csv("data/age_scale_factors.csv")
sfIFR <- cruise_ship_SFs$ifrSF
cruise_ship_by_confirmation$date <- as.Date(cruise_ship_by_confirmation$date)
# age distribution of cruise ship individuals
cruise_ship_ages <- c(16,23,347, 428,334,398,923,1015,216,11)
# running the code to produce the IFR and CFR estimates quoted in the manuscript
cIFREstimate <- computecCFRTimeSeries(cruise_ship_by_confirmation, hospitalisation_to_death_truncated_mid_one, f_truncrated_mid_one)
cIFREstimate
